import{_ as n}from"./plugin-vue_export-helper.21dcd24c.js";import{o as s,c as a,e}from"./app.09d9ce72.js";const t={},i=e(`<h1 id="lua\u811A\u672C" tabindex="-1"><a class="header-anchor" href="#lua\u811A\u672C" aria-hidden="true">#</a> LUA\u811A\u672C</h1><p>Redis \u901A\u8FC7 LUA \u811A\u672C\u521B\u5EFA\u5177\u6709\u539F\u5B50\u6027\u7684\u547D\u4EE4\uFF1A \u5F53lua\u811A\u672C\u547D\u4EE4\u6B63\u5728\u8FD0\u884C\u7684\u65F6\u5019\uFF0C\u4E0D\u4F1A\u6709\u5176\u4ED6\u811A\u672C\u6216 Redis \u547D\u4EE4\u88AB\u6267\u884C\uFF0C\u5B9E\u73B0\u7EC4\u5408\u547D\u4EE4\u7684\u539F\u5B50\u64CD\u4F5C\u3002</p><p>\u5728Redis\u4E2D\u6267\u884CLua\u811A\u672C\u6709\u4E24\u79CD\u65B9\u6CD5\uFF1Aeval\u548Cevalsha\u3002</p><p>eval \u547D\u4EE4\u4F7F\u7528\u5185\u7F6E\u7684 Lua \u89E3\u91CA\u5668\uFF0C\u5BF9 Lua \u811A\u672C\u8FDB\u884C\u6C42\u503C\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>//\u7B2C\u4E00\u4E2A\u53C2\u6570\u662Flua\u811A\u672C\uFF0C\u7B2C\u4E8C\u4E2A\u53C2\u6570\u662F\u952E\u540D\u53C2\u6570\u4E2A\u6570\uFF0C\u5269\u4E0B\u7684\u662F\u952E\u540D\u53C2\u6570\u548C\u9644\u52A0\u53C2\u6570
&gt; eval &quot;return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}&quot; 2 key1 key2 first second
1) &quot;key1&quot;
2) &quot;key2&quot;
3) &quot;first&quot;
4) &quot;second&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="evalsha" tabindex="-1"><a class="header-anchor" href="#evalsha" aria-hidden="true">#</a> evalsha</h2><p>Redis\u8FD8\u63D0\u4F9B\u4E86evalsha\u547D\u4EE4\u6765\u6267\u884CLua\u811A\u672C\u3002\u9996\u5148\u8981\u5C06Lua\u811A\u672C\u52A0\u8F7D\u5230Redis\u670D\u52A1\u7AEF\uFF0C\u5F97\u5230\u8BE5\u811A\u672C\u7684SHA1\u6821\u9A8C\u548C\u3002Evalsha \u547D\u4EE4\u6839\u636E\u7ED9\u5B9A\u7684 sha1 \u6821\u9A8C\u548C\uFF0C\u6267\u884C\u7F13\u5B58\u5728\u670D\u52A1\u5668\u4E2D\u7684\u811A\u672C\u3002</p><p>script load\u547D\u4EE4\u53EF\u4EE5\u5C06\u811A\u672C\u5185\u5BB9\u52A0\u8F7D\u5230Redis\u5185\u5B58\u4E2D\u3002</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>redis 127.0.0.1:6379&gt; SCRIPT LOAD &quot;return &#39;hello moto&#39;&quot;
&quot;232fd51614574cf0867b83d384a5e898cfd24e5a&quot;

redis 127.0.0.1:6379&gt; EVALSHA &quot;232fd51614574cf0867b83d384a5e898cfd24e5a&quot; 0
&quot;hello moto&quot;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F7F\u7528evalsha\u6267\u884CLua\u811A\u672C\u8FC7\u7A0B\u5982\u4E0B\uFF1A</p><p><img src="http://img.dabin-coder.cn/image/evalsha.png" alt="" loading="lazy"></p><h2 id="lua\u811A\u672C\u4F5C\u7528" tabindex="-1"><a class="header-anchor" href="#lua\u811A\u672C\u4F5C\u7528" aria-hidden="true">#</a> lua\u811A\u672C\u4F5C\u7528</h2><p>1\u3001Lua\u811A\u672C\u5728Redis\u4E2D\u662F\u539F\u5B50\u6267\u884C\u7684\uFF0C\u6267\u884C\u8FC7\u7A0B\u4E2D\u95F4\u4E0D\u4F1A\u63D2\u5165\u5176\u4ED6\u547D\u4EE4\u3002</p><p>2\u3001Lua\u811A\u672C\u53EF\u4EE5\u5C06\u591A\u6761\u547D\u4EE4\u4E00\u6B21\u6027\u6253\u5305\uFF0C\u6709\u6548\u5730\u51CF\u5C11\u7F51\u7EDC\u5F00\u9500\u3002</p><h2 id="\u5E94\u7528\u573A\u666F" tabindex="-1"><a class="header-anchor" href="#\u5E94\u7528\u573A\u666F" aria-hidden="true">#</a> \u5E94\u7528\u573A\u666F</h2><p>\u9650\u5236\u63A5\u53E3\u8BBF\u95EE\u9891\u7387\u3002</p><p>\u5728Redis\u7EF4\u62A4\u4E00\u4E2A\u63A5\u53E3\u8BBF\u95EE\u6B21\u6570\u7684\u952E\u503C\u5BF9\uFF0Ckey\u662F\u63A5\u53E3\u540D\u79F0\uFF0Cvalue\u662F\u8BBF\u95EE\u6B21\u6570\u3002\u6BCF\u6B21\u8BBF\u95EE\u63A5\u53E3\u65F6\uFF0C\u4F1A\u6267\u884C\u4EE5\u4E0B\u64CD\u4F5C\uFF1A</p><ul><li>\u901A\u8FC7aop\u62E6\u622A\u63A5\u53E3\u7684\u8BF7\u6C42\uFF0C\u5BF9\u63A5\u53E3\u8BF7\u6C42\u8FDB\u884C\u8BA1\u6570\uFF0C\u6BCF\u6B21\u8FDB\u6765\u4E00\u4E2A\u8BF7\u6C42\uFF0C\u76F8\u5E94\u7684\u63A5\u53E3count\u52A01\uFF0C\u5B58\u5165redis\u3002</li><li>\u5982\u679C\u662F\u7B2C\u4E00\u6B21\u8BF7\u6C42\uFF0C\u5219\u4F1A\u8BBE\u7F6Ecount=1\uFF0C\u5E76\u8BBE\u7F6E\u8FC7\u671F\u65F6\u95F4\u3002\u56E0\u4E3A\u8FD9\u91CCset()\u548Cexpire()\u7EC4\u5408\u64CD\u4F5C\u4E0D\u662F\u539F\u5B50\u64CD\u4F5C\uFF0C\u6240\u4EE5\u5F15\u5165lua\u811A\u672C\uFF0C\u5B9E\u73B0\u539F\u5B50\u64CD\u4F5C\uFF0C\u907F\u514D\u5E76\u53D1\u8BBF\u95EE\u95EE\u9898\u3002</li><li>\u5982\u679C\u7ED9\u5B9A\u65F6\u95F4\u8303\u56F4\u5185\u8D85\u8FC7\u6700\u5927\u8BBF\u95EE\u6B21\u6570\uFF0C\u5219\u4F1A\u629B\u51FA\u5F02\u5E38\u3002</li></ul><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">buildLuaScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;local c&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;\\nc = redis.call(&#39;get&#39;,KEYS[1])&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;\\nif c and tonumber(c) &gt; tonumber(ARGV[1]) then&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;\\nreturn c;&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;\\nend&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;\\nc = redis.call(&#39;incr&#39;,KEYS[1])&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;\\nif tonumber(c) == 1 then&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;\\nredis.call(&#39;expire&#39;,KEYS[1],ARGV[2])&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;\\nend&quot;</span> <span class="token operator">+</span>
        <span class="token string">&quot;\\nreturn c;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token class-name">String</span> luaScript <span class="token operator">=</span> <span class="token function">buildLuaScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">RedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Number</span><span class="token punctuation">&gt;</span></span> redisScript <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRedisScript</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>luaScript<span class="token punctuation">,</span> <span class="token class-name">Number</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Number</span> count <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>redisScript<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> limit<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> limit<span class="token punctuation">.</span><span class="token function">period</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,19),p=[i];function o(l,c){return s(),a("div",null,p)}var d=n(t,[["render",o],["__file","10-lua.html.vue"]]);export{d as default};
